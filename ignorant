// Set up the API endpoint and headers
const apiEndpoint = 'https://chatbot.theb.ai/api/chat-process';
const apiHeaders = {
  'authority': 'chatbot.theb.ai',
  'content-type': 'application/json',
  'origin': 'https://chatbot.theb.ai',
  'user-agent': navigator.userAgent,
};

// Function to send a request to the API and return the response
async function sendApiRequest(prompt) {
  try {
    const response = await fetch(apiEndpoint, {
      method: 'POST',
      headers: apiHeaders,
      body: JSON.stringify({
        prompt: prompt,
        options: {
          parentMessageId: Completion.last_msg_id || null
        }
      })
    });

    const data = await response.json();
    Completion.last_msg_id = data.id || Completion.last_msg_id;
    return data.delta || '';
  } catch (error) {
    console.error(error);
    return '‚ùå';
  }
}

// Function to update the URL with the given response
function updateUrl(response) {
  const currentUrl = location.href;
  const baseUrl = currentUrl.split('%')[0];
  const newUrl = baseUrl + '/' + response;
  const newTitle = 'My new page title';
  const newState = { additionalInformation: 'wlul' };
  window.history.pushState(newState, newTitle, newUrl);
}

// Create the chat interface elements
const container = document.createElement('div');
container.id = 'a';
container.style.position = 'fixed';
container.style.backgroundColor = 'transparent';
container.style.bottom = '0px';
container.style.right = '0px';
container.style.width = '400px';
container.style.height = '22px';
container.style.overflow = 'auto';

const text = document.createElement('span');
text.id = 'txt';
text.style.color = 'black';
text.style.opacity = '0.14';
text.style.fontFamily = "'Courier New', Courier, monospace";

container.appendChild(text);
document.body.appendChild(container);

// Prompt for the first question
const prompt = `I will give you an unformatted multiple-choice question with multiple answers here is an example of it may look like:
What is the capital of France?
*
1 point
Paris
Madrid
London
Berlin

When I provide you with the question, You will separate the choices into A, B, C, D, etc if there are more options, and ignore any extraneous text like "*" and point values.
Please respond with the letter of the correct answer.
Only respond with the letter of the correct answer.
Just the answer letter.

Like this: in that example question the answer that you should say is "A" you should not say anything before or after it, just the correct answer letter by it self.
Got it?
Here is my first question: `;

let highlightedText = '';

// Event listener for keydown events
document.addEventListener('keydown', async function(event) {
  // Clear the text element and get the selected text
  text.textContent = '';
  highlightedText = window.getSelection().toString();

  if (event.key === '\\' || event.key === '|') {
    // If the key pressed is "\" or "|", clear the text element and update the URL
    text.textContent = '';
    updateUrl('');
  } else if (event.key === ']' && highlightedText !== '') {
    // If the key pressed is "]", and there is selected text, send the request to the API and update the URL
    const response = await sendApiRequest(prompt + highlightedText);
    text.textContent = response;
    updateUrl(response);
  }
});
